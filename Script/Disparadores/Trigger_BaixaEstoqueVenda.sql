DROP TRIGGER BaixaEstoqueVeNda
GO

CREATE TRIGGER BaixaEstoqueVenda
ON T_ItensVendas
after INSERT
AS

DECLARE @parCod_Produto VARCHAR(5)
DECLARE @parQtde_venda Integer

DECLARE ItensVendas CURSOR FOR ( SELECT COD_PRODUTO, QTDE_VENDA FROM INSERTED )
BEGIN

   OPEN ItensVendas
   FETCH NEXT FROM ItensVendas INTO @parCod_Produto,@parQtde_Venda
   WHILE @@FETCH_STATUS = 0
   BEGIN
      UPDATE T_Produtos set Saldo = Saldo-@parQtde_Venda where Codigo=@parCod_Produto
      FETCH NEXT FROM ItensVendas INTO @parCod_Produto,@parQtde_Venda
   END 
   CLOSE ItensVendas
   DEALLOCATE ItensVendas

   SET NOCOUNT ON

   INSERT INTO T_MOVESTOQUE
               ( COD_EMP,COD_PRODUTO,DATA_CAD,DATA_MOV, E_S, OPERADOR, DOCUMENTO,
                 QTDE_BAIXA, ROTINA,SALDO_ANTERIOR, SALDO_POSTERIOR               ) 
   SELECT        '001',INSERTED.COD_PRODUTO,INSERTED.DATA_CAD,INSERTED.DATA_CAD,'S',
                 INSERTED.OPERADOR,INSERTED.SEQVENDA,INSERTED.QTDE_VENDA,'VENDA DE MERCADORIA (T_ITENSVENDAS) ',(T_PRODUTOS.SALDO+INSERTED.QTDE_VENDA), 
                 T_PRODUTOS.SALDO
   FROM INSERTED INNER JOIN T_PRODUTOS
   ON INSERTED.COD_PRODUTO = T_PRODUTOS.CODIGO

   SET NOCOUNT OFF
END


